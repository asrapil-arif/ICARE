
@using I_Care.Models
@{
    var ROLES = new I_Care.Classes.UserRoleProvider();

}


<style>

    #ModContract .modal-dialog {
        width: 80%;
        margin: 0 auto;
        margin-top: 1%;
        -webkit-box-shadow: -1px 11px 48px 3px rgba(0,0,0,0.75);
        -moz-box-shadow: -1px 11px 48px 3px rgba(0,0,0,0.75);
        box-shadow: -1px 11px 48px 3px rgba(0,0,0,0.75);
    }

	#ModContract .control-label {
	
			font-size:12px;
	
	}
</style>

<div id="ModContract" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" style="color:White;">&times;</button>
                <div class="modal-title" style="color:#292865;"></div>
            </div>
            <div class="modal-body" style="padding:0px;padding-top:10px;">
                <div class="tabbable">
                    <ul class="nav nav-tabs" id="myTab">

                        <li class="active">
                            <a data-toggle="tab" href="#info_contract" aria-expanded="true" style="border-left:none;">
                                <i class="fa fa-desktop"></i>
                                Main Info.
                            </a>
                        </li>


                        <li class="" id="tab_upload_caption" hidden>
                            <a data-toggle="tab" href="#tab_upload" aria-expanded="true">
                                <i class="fa fa-file"></i>
                                Upload File
                            </a>
                        </li>

                        <li class="" id="tab_upload_list_caption" hidden>
                            <a data-toggle="tab" href="#tab_upload_list" aria-expanded="true">
                                <i class="fa fa-file"></i>
                                Upload File List
                            </a>
                        </li>

                        <li class="">
                            <a data-toggle="tab" href="#tab_alert_config" aria-expanded="true">
                                <i class="fa fa-bell"></i>  Alert Configuration
                            </a>
                        </li>

                        <li class="" id="tab_history">
                            <a data-toggle="tab" href="#list_history" aria-expanded="true">
                                <i class="fa fa-history"></i>
                                Log. Process
                            </a>
                        </li>

                    </ul>

                    <div class="tab-content" style="min-height:300px;border-bottom:none;border-left:none;border-right:none;padding:0px;">
                        <div id="info_contract" class="tab-pane fade active in" style="padding:10px;">

                            <form class="form-horizontal">
                                <div class="box-body">

                                    @*<div class="form-group" id="idSelect" hidden="">
                                        <label for="inputName" class="col-sm-2 control-label">Id :</label>
                                            <div class="col-sm-10">
                                                <input class="form-control" id="ContractId" placeholder="Id. Will be generate by system" type="text" readonly style="background-color:whitesmoke;">
                                            </div>
                                        <label for="inputName" class="col-sm-2 control-label">Id :</label>
                                        <div class="col-sm-4">
                                            <select class="form-control select2" id="ContractId">
                                                
                                                <option value="" selected>-- Select Application No --</option>

                                                @foreach (var item in ViewBag._ProcurementList)
                                                {
                                                    <option value="@item.ContractId">@item.ContractId</option>
                                                }
                                            </select>
                                        </div>

                                    </div>*@
                                    <div class="form-group" id="idtext" hidden="">
                                        <label for="inputName" class="col-sm-2 control-label">Id :</label>
                                        <div class="col-sm-10">
                                            <input class="form-control" id="ContractId" placeholder="Id. Will be generate by system" type="text" readonly style="background-color:whitesmoke;" autocomplete="off">

                                        </div>


                                    </div>
                              

                                    <div id="IDParrent" class="form-group" hidden="">
                                        <label for="inputName" class="col-sm-2 control-label">Parent Id :</label>
                                        <div class="col-sm-10">
                                            <input class="form-control" id="parent_id" placeholder="Parent Id." type="text" readonly style="background-color:whitesmoke;cursor:pointer;color:blue;" autocomplete="off" ondblclick="goto_parent(this.value)">
                                        </div>


                                    </div>

                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">Contract Signing Officer :</label>
                                        <div class="col-sm-4">
                                            @*<input class="form-control" id="ContractSigningOfficer" placeholder="Contract Signing Officer" type="text">*@
                                            <select class="form-control select2" id="NM_PEG">
                                                <option value="" selected>-- Select Contract Signing Officer --</option>

                                                @foreach (var item in ViewBag.EmailList)
                                                {

                                            <option value="@item.NM_PEG">@item.NM_PEG - @item.NM_JABATAN_STR </option>

                                                }


                                            </select>

                                        </div>


                                        <label for="inputName" class="col-sm-2 control-label">Fungsi Name :</label>
                                        <div class="col-sm-4">

                                            <select class="form-control select2" id="FungsiName">
                                                <option value="" selected>-- Select Fungsi Type --</option>

                                                @foreach (var item in ViewBag.LookUpFungsi)
                                                {

                                                    <option value="@item.LookId">@item.LookName</option>

                                                }


                                            </select>

                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">Contract No. :</label>
                                        <div class="col-sm-4">
                                            <input class="form-control" id="ContractNo" placeholder="Contract No." type="text" autocomplete="off">
                                        </div>


                                        <label for="inputName" class="col-sm-2 control-label">Contract Type :</label>
                                        <div class="col-sm-4">

                                            <select onchange="myFunction()" class="form-control select2" id="ContractType">
                                                <option value="" selected>-- Select Contract Type --</option>

                                                @foreach (var item in ViewBag.ContractType)
                                                {
                                                    <option value="@item.Id">@item.ContractType</option>
                                                }

                                            </select>
                                            <script>
                                                function myFunction() {
                                                    document.getElementById("ContractValue").value = "";
                                                    var value = document.getElementById("ContractType").value;
                                                    document.getElementById('divIDClass').hidden = true;
                                                    if (value == 1) {
                                                        document.getElementById("ContractValue").value = 1;//(1).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
                                                        document.getElementById("temp_ContractValue").value = 1;
                                                        document.getElementById('divIDClass').hidden = false;
                                                    }
                                                }
                                            </script>
                                        </div>

                                    </div>
                                    <div class="form-group" id="AddendumContr1" hidden="">
                                        <label for="inputName" class="col-sm-2 control-label">Addendum Contract No Before :</label>
                                        <div class="col-sm-4">
                                            <input disabled="" class="form-control" id="addendumContractNo1" placeholder="Addendum Contract No 1" type="text" autocomplete="off">
                                        </div>
                                    </div>
                                    <div class="form-group" id="AddendumContr" hidden="">
                                        <label for="inputName" class="col-sm-2 control-label">Addendum Contract No :</label>
										<div class="col-sm-4">
											<input class="form-control" id="addendumContractNo" placeholder="Addendum Contract No" type="text" autocomplete="off"> 
										</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">Contract Title :</label>
                                        <div class="col-sm-10">
                                            <input class="form-control" id="ContractTitle" placeholder="Contract Title" type="text" autocomplete="off">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">PR :</label>
                                        <div class="col-sm-5">
                                            <input class="form-control" id="ContractPR" placeholder="PR." type="text" autocomplete="off">
                                        </div>

                                        <label for="inputName" class="col-sm-1 control-label">PO :</label>
                                        <div class="col-sm-4">
                                            <input class="form-control" id="ContractPO" placeholder="PO" type="text" autocomplete="off">
                                        </div>

                                    </div>



                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">Total Contract Value :</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="temp_ContractValue" hidden />
                                            <input class="form-control" id="ContractValue" placeholder="Value." type="text" onselect="format_currency('ContractValue','temp_ContractValue')" onkeyup="format_currency('ContractValue','temp_ContractValue')" onmouseup="format_currency('ContractValue','temp_ContractValue')" autocomplete="off">
                                        </div>
                                    </div>

                                    <div class="form-group">

                                        <label for="inputName" class="col-sm-2 control-label">Periode :</label>
                                        <div class="col-sm-2">
                                            <input class="form-control date-picker" id="StartDate" data-date-format="dd-mm-yyyy" type="text" style="height:28px;"  placeholder="Start Date" autocomplete="off">
                                        </div>

                                        <div class="col-sm-2">
                                            <input id="EndDate" class="form-control date-picker" type="text" style="height:28px;"  placeholder="End Date" autocomplete="off">

                                        </div>

                                        <label for="inputName" class="col-sm-2 control-label">Contract Date :</label>
                                        <div class="col-sm-4">
                                            <input id="ContractDate" class="form-control date-picker" type="text" style="height:28px;"  placeholder="Contract Date" autocomplete="off">

                                        </div>
                                    </div>
                                    <div class="form-group" id="divIDClass" hidden="">

                                        <label for="inputName" class="col-sm-2 control-label">Project Date :</label>
                                        <div class="col-sm-2">
                                            <input class="form-control date-picker" id="StartProject" data-date-format="dd-mm-yyyy" type="text" style="height:28px;"  placeholder="Start Project" autocomplete="off">
                                        </div>

                                        <div class="col-sm-2">
                                            <input id="EndProject" class="form-control date-picker" type="text" style="height:28px;"  placeholder="End Project" autocomplete="off">

                                        </div>

                                    </div>
                                    <div class="form-group">

                                        <label for="inputName" class="col-sm-2 control-label">Vendor</label>
										<div class="col-sm-10">

											<select class="form-control select2" id="ContractVendor">
												<option value="" selected>-- Select an Vendor --</option>

												@foreach (var item in ViewBag.VendorList)
												{

												<option value="@item.Id">@item.Id - @item.VendorId -  @item.VendorName </option>

												}


											</select>

										</div>
                                    </div>


                                    <div class="form-group">
                                        <label for="inputName" class="col-sm-2 control-label">Remark :</label>
                                        <div class="col-sm-10">

                                            <textarea class="form-control" placeholder="Remark" id="Remark" style="color:#333;resize:none;font-size:11px;padding-left:3px;" autocomplete="off"></textarea>

                                        </div>
                                    </div>


                                </div>
                            </form>

                        </div>


                        <div id="tab_upload" class="tab-pane fade" style="padding:0px;padding-top:10px;">


                            <div class="col-sm-12">
                                <input multiple="" type="file" id="contract_file" required accept=".jpg,.jpeg,.pdf,.png,.xls" />
                                <span style="font-style:normal;text-align:center;font-size:12px;color:blue;">
                                    Note : Anda disarankan untuk mengunggah file pendukung yang diperlukan,
                                </span>
                                <span style="font-style:normal;text-align:center;font-size:12px;color:red;">
                                    Jika file yang anda upload terlalu besar disarankan untuk mengupload parsial setelah draft ini tersimpan.
                                </span>
                            </div>



                        </div>

                        <div id="tab_upload_list" class="tab-pane fade" style="padding:0px;padding-top:0px;">

                            <table border="0" width="100%" align="center" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td width="50%" valign="top" style="padding-top:1px;">
                                        <div id="gridUpload" style="height:297px;border:none;border-radius:0px;border-top:1px solid #dedede;border-right:0px solid #dedede;"></div>
                                    </td>
                                    <td valign="middle" style="border-left:1px solid #ccc;">
                                        <div id="preview_file" style="text-align:center;">
                                            <iframe src="" scrolling="no" id="frame_preview" frameborder="0" style="width:100%;height:290px;border:1px;"></iframe>
                                        </div>
                                    </td>

                                </tr>
                            </table>

                        </div>

                        <div id="tab_alert_config" class="tab-pane fade" style="padding:0px;padding-top:0px;">



                            <table border="0" width="100%" align="center" cellpadding="0" cellspacing="0">

                                <tr>
                                    <td width="60%" valign="top" style="padding-top:1px;">
                                        <div id="gridEmail" style="height:298px;border:none;border-radius:0px;border-top:1px solid #ccc;border-right:0px solid #dedede;"></div>
                                    </td>
                                    <td valign="top" style="border-left:1px solid #ccc;">
                                        <div id="setting_box" style="padding:10px;padding-top:30px;">



                                            <div style="font-size:20px;padding-left:10px;">Alert Setting</div><br />

                                            <div class="form-group">
                                                <label for="inputName" class="col-sm-4 control-label">Enabled Alert</label>
                                                <div class="col-sm-6">


                                                    <div class="col-xs-2">

                                                        <label>
                                                            <input name="switch-field-1" class="ace ace-switch" type="checkbox" id="Snooze" />
                                                            <span class="lbl"></span>
                                                        </label>
                                                    </div>

                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="inputName" class="col-sm-4 control-label">Start From</label>
                                                <div class="col-sm-6">

                                                    <input type="text" id="AlertDay" readonly />

                                                    <span class="lbl" style="font-size:11px;">Day before contract expire</span>

                                                </div>
                                            </div>

                                        </div>
                                    </td>

                                </tr>
                            </table>

                        </div>

                        <div id="list_history" class="tab-pane fade" style="padding:0px;padding-top:1px;">

                            <div id="gridHistory" style="height:299px;border:none;border-radius:0px;border-top:1px solid #dedede;border-right:0px solid #dedede;"></div>

                        </div>


                    </div>
                </div>

            </div>
            <div class="modal-footer" id="fot_form_contract">



            </div>
        </div>

    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="ModalVendor" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color:#438EB9;color:White;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select an Vendor</h4>
                <span style="font-size:11px;">Double click on item or select an item and click select button  !</span>
            </div>
            <div class="modal-body" style="padding:0px;">

                <div id="gridVendor" style="height:390px;border:none;border-radius:0px;border-top:1px solid #dedede;border-right:0px solid #dedede;"></div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="select_vendor()">Select</button>
            </div>
        </div>
    </div>
</div>




<!-- Modal -->
<div class="modal fade" id="modal_upload" role="dialog" style="margin-top:5%;">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="background-color:#438EB9;color:White;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Upload File</h4>
            </div>
            <div class="modal-body">
                <input multiple="" type="file" id="contract_file_other" required accept=".jpg,.jpeg,.pdf,.png,.xls" />

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="upload_file_other()">Upload</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="info_report" role="dialog" style="margin-top:5%;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Get Report Data Of Contract</h4>
            </div>
            <br />
            <label for="inputName" class="col-sm-4 control-label">Set Periode :</label>
            <div class="col-sm-2">
                <input class="form-control date-picker" id="StartDateFDC" data-date-format="dd-mm-yyyy" type="text" style="height:28px;" readonly placeholder="Start Date">
                @*<input class="form-control date-picker" id="StartDate" data-date-format="dd-mm-yyyy" type="text" style="height:28px;" readonly placeholder="Start Date">*@
            </div>

            <div class="col-sm-2">
                <input id="EndDateFDC" class="form-control date-picker" type="text" style="height:28px;" readonly placeholder="End Date">
                @*<input id="EndDate" class="form-control date-picker" type="text" style="height:28px;" readonly placeholder="End Date">*@

            </div>
            <br />
            <br />
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-sm" onclick="download_report('EXCEL')">Download Excel</button>
                <button type="button" class="btn btn-default btn-sm" onclick="form_default()" data-dismiss="modal">Cancel</button>

            </div>
        </div>
    </div>
</div>

<script>



	var TempDelete = [];
	var CurrentContract = [];
	

    function form_contract_detail(FLAG,record,Roles,ViewFor) {
		
		$('a[href="#info_contract"]').tab('show');
		CurrentContract = record;
		$('#StartDate,#EndDate,#ContractDate,#StartProject,#EndProject').w2field('date', { format: 'yyyy/mm/dd' }); 
		$('#ModContract .modal-dialog').css('margin-top', "5%");

        switch (FLAG) {

			 
            case "EDIT":


				var DataSave = new FormData();
				DataSave.append('Id', record.ContractId);
				var allow_button = $.ajax({
					url: URL_PTPR + '/Button/GA_Kontrak_AllowButton',
					type: 'POST',
					data: DataSave,
					dataType: "json",
					cache: false,
					async: false,
					contentType: false,
					processData: false,
				});

				button_cancel = '</button><button type="button" class="btn tn-default btn-sm" data-dismiss="modal">Cancel</button>';
				button_action = allow_button.responseText;
				$("#fot_form_contract").html(button_action + button_cancel)


				$("#fot_form_contract").find("#btn_addendum,.btn-inverse").remove();
				
				

                document.getElementById('ContractId').disabled = true;
				fill_form(record);
				//if (ViewFor != "Log")view_history_process();
				view_history_process();
				view_upload(Roles, record);
				$("#ModContract .modal-title").html('General Affair Contract  : #Contract Id.' + record.ContractId + " #Contrat No." + record.ContractNo + " #" + record.DayAlert + ' #' + record.Creator);
				$("#tab_history").show();



				break;

			case "ADD":

				

				var CountProgress = $.ajax({
					type: "GET",
					url: URL_PTPR + '/Contract/GetCountGAContractStatus',
					dataType: 'json',
					cache: false,
					async: false,
				});

				DataProgress = CountProgress.responseJSON[0];
				if (DataProgress.AllowOverDue != 1) {
					w2alert("Terdapat  Kontrak Overdue,... lakukan tindakan terlebih dahulu !");
					return;
				}
				else {

					document.getElementById('ContractNo').disabled = false;

					$("#NM_PEG").val("").trigger('change');
					$("#ContractVendor").val("").trigger('change');
					$("#idtext").hide();
					$("#addendumContractNo1").hide();
					$("#AddendumContr1").hide();
					$("#ModContract .modal-title").html("Add New Contract");
					button = '<button type="button" class="btn btn-info btn-sm" onclick="save_contract(\'ADD\')"> <i class="fa fa-floppy-o" aria-hidden="true"></i> Save</button><button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Cancel</button>'
					$("#fot_form_contract").html(button);
					$("#tab_history").hide();
					$("#tab_upload_list_caption").hide();
					$("#tab_upload_caption").show();
					$("#frame_preview").attr("src", "");

					form_default();
					render_grid_mail();
				}

                break;

        }


        var file_input = $('#contract_file');
		file_input.ace_file_input('reset_input');
		
		$('a[href="#info_contract"]').tab('show');
		$('#ModContract').modal(
			{
				backdrop: 'static',
				keyboard: false
			}
		);
		
    }



	function create_addendum() {

		form_contract_detail('ADD', CurrentContract);
		$("#ModContract .modal-title").html('Create Addendum For  : #Contract Id.' + CurrentContract.ContractId + " #Contrat No." + CurrentContract.ContractNo + " #" + CurrentContract.DayAlert + ' #' + CurrentContract.Creator);
		fill_form(CurrentContract);
		$("#idtext").hide();
		$("#ContractId").val("");
		$("#tab_upload_list_caption").hide();
		$("#tab_upload_caption").show();
		$("#IDParrent").show();
		$("#parent_id").val(CurrentContract.ContractId);
		button = '<button type="button" class="btn btn-warning btn-sm" onclick="save_contract(\'ADDENDUM\')"> <i class="fa fa-floppy-o" aria-hidden="true"></i> Save Addendum</button><button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Cancel</button>'
		$("#fot_form_contract").html(button);
		
	}
	
	function form_default() {

		$("#IDParrent").hide();
		$("#parent_id").val("");
        $("#StartDateFDC").val("");
        $("#EndDateFDC").val("");
        $("#ContractId").val("");
        //$("#ContractSigningOfficer").val("");
        $("#NM_PEG").val("");
        $("#FungsiName").val("").trigger('change');
        $("#ContractNo").val("");
        $("#addendumContractNo").val("");
        $("#ContractTitle").val("");
        $("#ContractType").val("").trigger('change');

        $("#ContractPR").val("");
        $("#ContractPO").val("");
        $("#ContractValue").val("");
        $("#ContractValueTemp").val("");

        $("#StartDate").val("");
        $("#EndDate").val("");
        $("#StartProject").val("");
        $("#EndProject").val("");

        $("#ContractDate").val("");

        $("#ContractVendor").val("");
        //$("#ContractVendorId").val("");

        $("#Remark").val("");

        $("#AlertDay").val("10");
        $('#Snooze').prop('checked', true);
        $("#ContractType").val("").trigger('change');


	}

	function fill_form(record) {

		if (record.ParentId != null) {
			$("#IDParrent").show();
			$("#parent_id").val(record.ParentId);
		}
		else {

			$("#IDParrent").hide();
			$("#parent_id").val("");
		}
	
		$("#ContractId").val(record.ContractId);
		$("#idtext").show();
		$("#NM_PEG").val(record.PenanggungJawabPihak1).trigger('change');
		$("#FungsiName").val(record.Fungsi).trigger('change');
		$("#ContractNo").val(record.ContractNo);

		$("#ContractTitle").val(record.ContractTitle);
		$("#ContractPR").val(record.NoPR);
		$("#ContractPO").val(record.NoPO);
		$("#ContractType").val(record.ContractType).trigger('change');
		$("#temp_ContractValue").val(record.ContractValue);
		$("#ContractValue").val(numberWithCommas(record.ContractValue));

		$("#ContractVendor").val(record.IdVendor).trigger('change');;
		$("#StartDate").val(record.BeginDate);
		$("#EndDate").val(record.EndDate);
		$("#StartProject").val(record.StartProject);
		$("#EndProject").val(record.EndProject);
		$("#ContractDate").val(record.ContractDate);
		$("#Remark").val(record.Remark);

		$("#frame_preview").attr("src", "");

		$("#tab_upload_caption").hide();
		$("#tab_upload_list_caption").hide();

		$("#DocType").attr("disabled", true);


		$("#AlertDay").val(record.AlertDay);

		if (record.Snooze == 1) {

			$('#Snooze').prop('checked', false);
		}
		else {

			$('#Snooze').prop('checked', true);
		}


		render_grid_mail(record.ContractId);
	
		


	}


	function goto_parent(contractid) {

		var record_;
		var PostParam = new FormData();
		PostParam.append('ContractId', contractid);
		var get_date_contract = $.ajax({
			url: URL_PTPR + '/EContract/GetGA_E_ContractCurrent',
			type: 'POST',
			data: PostParam,
			dataType: "json",
			cache: false,
			async: false,
			contentType: false,
			processData: false,
		});

		record_ = get_date_contract.responseJSON[0];
		form_contract_detail("EDIT", record_);

	}

    function find_vendor() {

        if (w2ui['gridVendor'] != null) {
            w2ui['gridVendor'].destroy();
        }


        $('#ModalVendor').modal(
                    {
                        backdrop: 'static',
                        keyboard: false
                    }
                );

        $('#ModalVendor').on('shown.bs.modal', function() {

                    render_wait();

                    $('#gridVendor').w2grid({

                        name: 'gridVendor',
                        multiSelect     : false,
                        header: 'Daftar Contract',
                        textSearch: 'contains',
                        show: {
                        header          : false,
                        toolbar         : true,
                        footer          : true,
                        toolbarSearch    : false,
                        },
                        columns: [
                            { field: 'VendorId', caption: 'Id', size: '60px',sortable: true,searchable: 'text'  },
                            { field: 'VendorName', caption: 'Name', size: '100%',sortable: true,searchable: 'text'  },
                        ],
                         onDblClick: function (event) {
                            select_vendor();
                        },
                        onLoad: function (event) {
                            clear_wait();
                        },
                        onReload: function (event) {
                            refresh_vendor();
                        }

                    });


                    refresh_vendor();
        })
     }

   

     function refresh_vendor(){

      w2ui['gridVendor'].load(URL_PTR + '/Contract/ListVendor?status=7');


     }


     function select_vendor(){

        var sel = w2ui.gridVendor.getSelection() ;
        var record  = w2ui.gridVendor.get(sel[0]);
        $("#ContractVendorId").val(record.VendorId);
        $("#ContractVendor").val(record.VendorId + " - " + record.VendorName);
        $('#ModalVendor').modal("hide");


     }


     function render_grid_mail(contract){

                if (w2ui['gridEmail'] != null) {
                    w2ui['gridEmail'].destroy();
                }


                TempDelete = [];

                $('#gridEmail').w2grid({
                    name: 'gridEmail',
                    header : 'Mail Destination',
                    show: {
                    header          : true,
                    footer          : true,
                    lineNumbers     : true,
                    toolbarAdd      : false,
                    toolbarDelete   : true,
                    toolbar         : true,
                    toolbarSearch   : false,
                    },
                    columns: [

						{ field: 'Email', caption: 'Mail Destination', size: '200px', searchable: 'text', editable: { type: 'text' } },
                        { field: 'Name', caption: 'Name', size: '200px',searchable:'text',editable: { type: 'text' } },
                        { field: 'Jabatan', caption: 'Jabatan', size: '200px', searchable: 'text', editable: { type: 'text' } },


                    ],
                    toolbar: {
                        items: [
                            { id: 'add', type: 'button', caption: 'Add Record', icon: 'w2ui-icon-plus' }
                        ],
                        onClick: function (event) {
                            if (event.target == 'add') {

                                w2ui.gridEmail.save();
                                var list_Rec    = w2ui['gridEmail'].records;
                                var new_rec =  new Array();

                                if (list_Rec.length > 0){

									for (x = 0; x < list_Rec.length; x++){

                                        new_rec.push(list_Rec[x].recid);

                                    }

                                    var new_recid = Math.max.apply(Math, new_rec);
									w2ui.gridEmail.add({ recid: new_recid + 1, FlagStat:'new'});
                                 }
                                 else{

									w2ui.gridEmail.add({ recid: 1, FlagStat: 'new'});
                                 }

                            }
                        }
                    },
                    onDelete: function (event) {

                        var sel = this.getSelection();
                        if (event.force == true){


                            sel.forEach(function(entry) {

                                var record = w2ui.gridEmail.get(entry);

                                if (record.Flag_Exists = 1){

                                    TempDelete.push({Id:record.recid});

                                }

                            });



                        }

                    }

                });

        refresh_mail_alert(contract);

    }

    function refresh_mail_alert(Contract){

        w2ui['gridEmail'].load(URL_PTR + '/Contract/ContractListMailAlert?Contract='+ Contract);


    }


    function view_history_process(){


                if (w2ui['gridHistory'] != null) {
                    w2ui['gridHistory'].destroy();
                }

                 var ContractId = $("#ContractId").val();

                $('#gridHistory').w2grid({
                name: 'gridHistory',
                url : URL_PTR + '/EContract/ListHistoryEContract?ContractId=' +ContractId,
                show: {
                header          : false,
                footer          : true,
                lineNumbers     : false,
                toolbarAdd      : true,
                toolbarDelete   : true,
                },
                columns: [
					{ field: 'FromName', caption: 'From', size: '200px', info : true},
					{ field: 'ToName', caption: 'To', size: '200px' },
                    { field: 'Descriptions', caption: 'Note', size: '600px' },
                    { field: 'Executor', caption: 'Executor', size: '100%' },
                ]
                });


    }



    function view_upload(Roles,record){

        var ToolBarE = false;
        var UserOwner = '@User.Identity.Name.ToString()';

        @if (ROLES.CheckAllowModul(User.Identity.Name.ToString(), "MOD2018020002",3) == true)
        {
        <text>

        if (record.CreateUser == UserOwner){

            ToolBarE = true;
        }
        </text>
        }

        @if ((ROLES.CheckAccGroupIstrue(User.Identity.Name.ToString(), "ACCG2018010003") == true) || (ROLES.CheckAccGroupIstrue(User.Identity.Name.ToString(), "ACCG2018010004") == true))
        {

        <text>ToolBarE = true;</text>

        }

        if (w2ui['gridUpload'] != null) {

                w2ui['gridUpload'].destroy();

        }


       $('#gridUpload').w2grid({
                name: 'gridUpload',
                show: {
                footer          : true,
                toolbar         : ToolBarE,
                lineNumbers     : true,
                toolbarAdd      : true,
                toolbarDelete   : true,
                toolbarInput    : false,
                toolbarReload   : false,
                toolbarColumns   : false,
                },
                columns: [
                    { field: 'FileName', caption: 'File Name', size: '300px' },
                    { field: 'FileName', caption: '', size: '150px' ,
						render: function (record) {


                           
							var download
							if (record.API == 'Docman') {
								download = '<a href="' + URL_PTPR + '/File/' + record.recid + '" target="_blank"><i class="fa fa-cloud-download" aria-hidden="true" ></i> View Full Page</a>';

							}
							else {
								download = '<a href="' + URL_PTPR + '/File_Contract/' + record.FileName + '" target="_blank"><i class="fa fa-cloud-download" aria-hidden="true" ></i> View Full Page</a>';

							}

							return download;

                          }
                    },

                ]
                ,onAdd: function (event) {
                       form_upload_file();
                },
                onReload: function (event) {
                        refresh_upload($("#ContractId").val());
                },
				onSelect: function (event) {


					if (event.recid != undefined) {

						var record = this.get(event.recid);
						var file_url = "";

						if (record.API == 'Docman') {
							var file_url = URL_PTR + "/Contract/File?id=" + record.Id;
						}
						else {
							var file_url = URL_PTPR + "/File_Contract/" + record.FileName;
						}

						$("#frame_preview").attr("src", file_url);

					}

                },
                onUnselect: function(event) {
                         $("#frame_preview").attr("src", "");
                },
                onDelete: function (event) {

                var sel = this.getSelection();
                if (event.force == true){

                render_wait();

                sel.forEach(function(entry) {

                    var record = w2ui.gridUpload.get(entry);

                        var Delete =   $.ajax({
                        url: URL_PTR + '/Contract/DeleteAttachmentContract?id='+ record.recid,
                        type: 'POST',
                        dataType: "json",
                        cache: false,
                        async: false,
                        contentType: false,
                        processData: false,
                        });


                });


                    clear_wait();
                    $('#modal_upload').modal("hide");

                    }

                },

         });

        var ID = $("#ContractId").val();
        refresh_upload(ID);
    }


    function  refresh_upload(ID){

        w2ui['gridUpload'].load(URL_PTR + '/Contract/T_Attacment?ContractId=' + ID);
    }


    function form_upload_file(){

         var file_input = $('#contract_file_other');
        file_input.ace_file_input('reset_input');

        $('#modal_upload').modal(
        {
        backdrop: 'static',
        keyboard: false
        }

        );

    }

    function upload_file_other(){

        var DataSave = new FormData();
        var file    = $("#contract_file_other").files;

        var fileUploads = $("#contract_file_other").get(0);
        var files = fileUploads.files;


        if (files.length == 0){

            w2alert("Select an file before pelase !");
            return;

        }

        for (var i = 0; i < files.length; i++) {
            DataSave.append(files[i].name, files[i]);
        }

        DataSave.append('ContractId',$("#ContractId").val());

        render_wait();

        var Simpan =   $.ajax({
        url: URL_PTR + '/Contract/ProcessUploadFileContract',
        type: 'POST',
        data: DataSave,
        dataType: "json",
        cache: false,
        async: false,
        contentType: false,
        processData: false,
        });


        clear_wait();

        if (Simpan.responseJSON["Result"] != "Error"){

            alert("Upload new file success !");
            var ID = $("#ContractId").val();
            refresh_upload(ID);
            $('#modal_upload').modal("hide");

        }
        else{
            alert("Upload file fail try again !");
        }



    }




    function save_contract(FLAG,Roles) {


        if ($("#NM_PEG").val() == "") {

			$('a[href="#info_contract"]').tab('show');
			$("#NM_PEG").select2('open')
            return;

        }
        if ($("#FungsiName").val() == "") {

			$('a[href="#info_contract"]').tab('show');
			$("#FungsiName").select2('open');
            return;


        }

        if ($("#ContractNo").val()==""){

            $('a[href="#info_contract"]').tab('show');
            $("#ContractNo").focus();
            $("#ContractNo").attr("placeholder", "Contract No may not be empty !");
            return;

        }

        if ($("#ContractType").val()==""){

			$('a[href="#info_contract"]').tab('show');
			$("#ContractType").select2('open');
            return;


    }


        if ($("#ContractTitle").val()==""){

            $('a[href="#info_contract"]').tab('show');
            $("#ContractTitle").focus();
            $("#ContractTitle").attr("placeholder", "Contract Title No may not be empty !");
            return;

        }

  
        if ($("#ContractValue").val()==""){

            $('a[href="#info_contract"]').tab('show');
            $("#ContractValue").focus();
            $("#ContractValue").attr("placeholder", "Contract Value may not be empty !");
            return;

        }



        if ($("#StartDate").val()==""){

				$('a[href="#info_contract"]').tab('show');
				$("#StartDate").focus();
				//w2alert("Start date is empty!");
            return;

        }

        if ($("#EndDate").val()==""){

				$('a[href="#info_contract"]').tab('show');
				$("#EndDate").focus();
				//w2alert("End date is empty!");
            return;

        }

        if ($("#ContractDate").val()==""){

				$('a[href="#info_contract"]').tab('show');
				$("#ContractDate").focus();
				//w2alert("Contract Date is empty!");
            return;

        }

        if ($("#ContractVendor").val()==""){

			$('a[href="#info_contract"]').tab('show');
			$("#ContractVendor").select2('open');
            return;

        }


        var fileUpload = $("#contract_file").get(0);
        var files = fileUpload.files;

        if (FLAG == "ADD" || FLAG == "AddAdendum"){
            if (files.length ==0){

				w2alert("Harap sertakan file pendukung !");
                $('a[href="#tab_upload"]').tab('show');
                return;

            }
        }


        var DataSave = new FormData();
		debugger;

		DataSave.append('FlagCrud', FLAG);
        DataSave.append('ContractId', $("#ContractId").val());
		DataSave.append('ParentId', $("#parent_id").val());
        DataSave.append('PenanggungJawabPihak1', $("#NM_PEG").val());
        DataSave.append('Fungsi', $("#FungsiName").val());
        DataSave.append('ContractNo', $("#ContractNo").val());
        DataSave.append('AddendumContractNo', $("#addendumContractNo").val());
        DataSave.append('ContractType', $("#ContractType").val());
        DataSave.append('ContractTitle', $("#ContractTitle").val());
        DataSave.append('ContractPO', $("#ContractPO").val());
        DataSave.append('ContractPR', $("#ContractPR").val());
        DataSave.append('ContractValue', $("#temp_ContractValue").val());
        DataSave.append('StartDate', $("#StartDate").val());
        DataSave.append('EndDate', $("#EndDate").val());
        DataSave.append('StartProject', $("#StartProject").val());
        DataSave.append('EndProject', $("#EndProject").val());
        DataSave.append('ContractDate', $("#ContractDate").val());
        DataSave.append('ContractVendorId', $("#ContractVendor").val());
        DataSave.append('Remark', $("#Remark").val());
		DataSave.append('AlertDay', $("#AlertDay").val());
		DataSave.append('ProcId', '0');

        debugger
        w2ui['gridEmail'].save();
        var ListDest = w2ui['gridEmail'].records;
        var Jabatan = w2ui['gridEmail'].find({ Jabatan: 'Manager' });
        var Jabatan2 = w2ui['gridEmail'].find({ Jabatan: 'manager' });

        //data_bridging
        if (ListDest.length < 3) {
			alert("Harap sertakan Min 3 Email !");
			$('a[href="#tab_alert_config"]').tab('show');
            return;
        }
        else if (Jabatan.length == 0 && Jabatan2.length == 0) {
			alert("Harap sertakan Email Manager !");
			$('a[href="#tab_alert_config"]').tab('show');
                return;
            }
		else {

            //var Daat_ = JSON.stringify(ListDest);
            var Daat_del = JSON.stringify(TempDelete);

            //DataSave.append('ListAdd', Daat_);
            //DataSave.append('ListDelete', Daat_del);

			var ListDest_ = JSON.stringify(ListDest);
			DataSave.append('MailDestinations', ListDest_);
			DataSave.append('MailDestinationsDel', Daat_del);
        }
       

        if ($('#Snooze').is(":checked")){

            DataSave.append('Snooze', "0");
        }
        else{

            DataSave.append('Snooze', "1");
        }



        var fileUpload = $("#contract_file").get(0);
        var files = fileUpload.files;

        if (FLAG == "ADD" || FLAG == "AddAdendum"){

            if (Roles == undefined){

                for (var i = 0; i < files.length; i++) {

                    DataSave.append(files[i].name, files[i]);


                }

            }

        }


        render_wait()

        var Simpan =   $.ajax({
			url: URL_PTR + '/Contract/SaveGAContract',
            type: 'POST',
            data: DataSave,
            dataType: "json",
            cache: false,
            async: false,
            contentType: false,
            processData: false,
        });


        if (  Simpan.responseJSON["Result"].toLocaleLowerCase().indexOf("error")!=-1 ){

                clear_wait();
				w2alert(Simpan.responseJSON["Result"]);

        }
        else{

				w2alert('Save Data Success !');
				$("#ModContract").modal("hide");
				clear_wait();
				refresh_contract_list();
        }

     }




    function format_currency(Field_ID,temp_field){

        if($("#"+Field_ID).val() != ""){

             var Nominal = $("#"+Field_ID).val();
             Nominal = Nominal.replace(/,/g , "");
             $("#"+temp_field).val(Nominal);
             var fix_num = numberWithCommas(Nominal);

             $("#"+Field_ID).val(fix_num);

        }
        else{

             $("#"+temp_field).val("");

        }

    }

    function get_volume(){

     var volume = Number($('#temp_nominal').val()/Number($('#price').val())).toFixed(2);
     $('#Volume').val(volume);
     format_currency("Volume","temp_volume");
     //$('#temp_volume').val(volume);



   }


    function send_alert(){

        var DataSave = new FormData();
        DataSave.append('ContractId',  $("#ContractId").val());

        render_wait();

        var Simpan =   $.ajax({
            url: URL_PTR + '/Alert/SendAlertGeneralContract',
            type: 'POST',
            data: DataSave,
            dataType: "json",
            cache: false,
            async: false,
            contentType: false,
            processData: false,
        });

          if (  Simpan.responseJSON["Result"].toLocaleLowerCase().indexOf("error")!=-1 ){

                clear_wait();
                alert(Simpan.responseJSON["Result"]);

        }
        else{

                alert('Send Alert Success !');
                clear_wait();

        }

    }


	//==================================================================================//
	//not fucntional core business sytem code ..............***
	$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

	var target = $(e.target).attr("href");

	if ((target == '#tab_alert_config')) {
	w2ui['gridEmail'].refresh();

	}

	if ((target == '#list_history')) {
	w2ui['gridHistory'].refresh();
	}

	if ((target == '#tab_upload_list')) {
	w2ui['gridUpload'].refresh();
	}

	});



	$('#AlertDay').ace_spinner({ value: 0, min: 0, max: 30, step: 1, btn_up_class: 'btn-info', btn_down_class: 'btn-info' })
	.closest('.ace-spinner')
	.on('changed.fu.spinbox', function () {
	});


	function AddTextBox() {
        var div = GetDynamicTextBox("");
        $("#TextBoxContainer").append(div);
	}


    function GetDynamicTextBox(value) {
        var div = $("<div />");

        var textBox = $("<input />").attr("type", "textbox").attr("name", "DynamicTextBox");
        textBox.val(value);
        div.append(textBox);

        var button = $("<input />").attr("type", "button").attr("value", "Remove");
        button.attr("onclick", "RemoveTextBox(this)");
        div.append(button);

        return div;
	}

    function RemoveTextBox(button) {
            $(button).parent().remove();
        }

    $(function () {
        var values = eval('@Html.Raw(ViewBag.Values)');
        if (values != null) {
            $("#TextBoxContainer").html("");
            $(values).each(function () {
                $("#TextBoxContainer").append(GetDynamicTextBox(this));
            });
        }
    });

</script>
